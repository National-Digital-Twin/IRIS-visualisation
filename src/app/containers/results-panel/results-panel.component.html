@if (buildingSelection()) {
  <div class="panel results-panel">
    <section>
      <div class="results-panel__header">
        <p class="results-panel__number">
          {{ buildingSelection()?.flat()?.length }} results in view
        </p>
        <mat-slide-toggle [color]="'primary'" [(ngModel)]="selectMultiple"
          >Select multiple</mat-slide-toggle
        >
      </div>
      <div class="results-panel__header">
        <button
          mat-flat-button
          class="results-panel__button"
          aria-label="Flag selected properties"
          [disabled]="!canFlagSelected()"
          (click)="flag.emit(checkedCards())">
          <img
            alt=""
            [src]="
              theme() === 'light'
                ? 'assets/icons/FlagPennant.svg'
                : 'assets/icons/FlagPennant_white.svg'
            " />
          Flag selected
        </button>
        @if (selectMultiple) {
          <button
            mat-flat-button
            [color]="'primary'"
            class="results-panel__button"
            [ngStyle]="{ width: '255px' }"
            (click)="downloadAll()">
            <img src="assets/icons/FileArrowDown_white.svg" alt="" />Download
            selected
          </button>
        } @else {
          <button
            mat-flat-button
            [color]="'primary'"
            class="results-panel__button"
            (click)="downloadAll()">
            <img src="assets/icons/FileArrowDown_white.svg" alt="" />Download
            all
          </button>
        }
      </div>
    </section>
    <section class="results-panel__cards-container">
      <cdk-virtual-scroll-viewport
        minBufferPx="500"
        maxBufferPx="1000"
        class="viewport"
        itemSize="143">
        <div
          *cdkVirtualFor="
            let dwellingSet of buildingSelection();
            templateCacheSize: 0;
            trackBy: trackByUPRN
          ">
          @if (dwellingSet.length === 1) {
            <c477-results-card
              (downloadData)="downloadBuilding($event)"
              [buildingUPRN]="selectedCardUPRN()"
              (cardSelected)="cardSelected($event)"
              (emitViewDetails)="viewDetails($event)"
              [checked]="cardIsChecked([dwellingSet[0]])"
              (toggleChecked)="onToggleChecked(dwellingSet[0])"
              (flag)="flag.emit([dwellingSet[0]])"
              (removeFlag)="removeFlag.emit(dwellingSet[0])"
              [card]="dwellingSet[0]"
              [select]="selectMultiple"></c477-results-card>
          } @else {
            <c477-results-card-expandable
              [buildingTOID]="selectedParentTOID()"
              [dwellings]="dwellingSet"
              [select]="selectMultiple"
              [cardIsChecked]="cardIsChecked.bind(this)"
              (emitViewDetails)="viewDetails($event)"
              (cardSelected)="cardSelected($event)"
              (toggleChecked)="onToggleChecked($event)"
              (flag)="flag.emit($event)"
              (removeFlag)="
                removeFlag.emit($event)
              "></c477-results-card-expandable>
          }
        </div>
      </cdk-virtual-scroll-viewport>
    </section>
  </div>
}
